<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routified</title>
    {% load static %}
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-customfonts/1.0.4/roboto-normal.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-customfonts/1.0.4/roboto-bold.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f4; }
        
        @keyframes fadeIn { from { background-color: rgba(0,0,0,0); } to { background-color: rgba(0,0,0,0.5); } }
        @keyframes slideIn { from { margin-top: -50px; opacity: 0; } to { margin-top: 5%; opacity: 1; } }
        @keyframes fadeOut { from { background-color: rgba(0,0,0,0.5); } to { background-color: rgba(0,0,0,0); } }
        @keyframes slideOut { from { margin-top: 5%; opacity: 1; } to { margin-top: -50px; opacity: 0; } }
        
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 15px 20px 20px 20px;
            border: 1px solid #888; width: 80%; max-width: 800px;
            border-radius: 8px; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        .modal.fade-out { animation: fadeOut 0.3s ease-out forwards; }
        .modal.fade-out .modal-content { animation: slideOut 0.3s ease-out forwards; }

        .close-btn {
            color: #aaa; position: absolute; top: 10px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-btn:hover { color: #000; }
        
        .data-preview p { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        .data-preview strong { display: inline-block; width: 150px; }
        .data-preview ol { padding-left: 20px; }
        .data-preview ol li { margin-bottom: 5px; }
        
        button {
            padding: 8px 12px; border: none; border-radius: 4px;
            cursor: pointer; margin-right: 5px; font-size: 0.9em;
        }
        
        button:disabled {
            background-color: #ccc !important;
            color: #666 !important;
            cursor: not-allowed;
        }

        .add-btn-style { background-color: #28a745; color: white; }
        .edit-btn-style { background-color: #ffc107; color: black; }
        .view-btn-style { background-color: #007bff; color: white; }
        .delete-btn-style { background-color: #dc3545; color: white; }
        .cancel-btn-style { background-color: #6c757d; color: white; }
        .download-btn-style { background-color: #17a2b8; color: white; }
        .manage-btn-style { background-color: #fd7e14; color: white; }
        .map-btn-style { background-color: #17a2b8; color: white; }

        .main-action-btn { font-size: 1.1em; margin-bottom: 20px; padding: 10px 15px; }
        
        .modal-footer {
            margin-top: 15px; border-top: 1px solid #ccc;
            padding-top: 15px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .modal-footer button { padding: 10px 15px; font-size: 1em; }
        .modal-footer button.pull-left {
            margin-right: auto;
        }
        
        .item-list { list-style: none; padding: 0; }
        .item-list li {
            padding: 12px; border-bottom: 1px solid #ddd; display: flex;
            justify-content: space-between; align-items: center; background-color: #fff;
        }
        .item-list li:nth-child(odd) { background-color: #f9f9f9; }
        .item-list li span { flex-grow: 1; font-size: 1.1em; }
        
        .form-layout label {
            display: block; margin-top: 5px; font-weight: bold;
            font-size: 0.85em; color: #333;
        }
        .form-layout input[type="text"], .form-layout textarea {
            width: 100%; padding: 4px; margin-top: 2px; margin-bottom: 4px; 
            border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
        }
        
        .validation-error { color: #dc3545; font-size: 0.9em; margin-top: 10px; display: none; }
        
        .route-editor-container { display: flex; justify-content: space-between; gap: 20px; }
        .editor-column { width: 50%; border: 1px solid #ccc; border-radius: 4px; }
        .editor-column h4 {
            margin: 0; padding: 10px; background-color: #f0f0f0;
            border-bottom: 1px solid #ccc;
        }
        .editor-list {
            list-style: none; padding: 0; margin: 0;
            max-height: 400px; overflow-y: auto;
        }
        .editor-list li {
            padding: 8px 10px; border-bottom: 1px solid #eee; display: flex;
            justify-content: space-between; align-items: center;
        }
        #route-editor-current-list li { cursor: move; }
        .editor-list li:last-child { border-bottom: none; }
        .editor-list button { padding: 2px 6px; font-size: 0.8em; }
        
        .editor-search { padding: 8px; border-bottom: 1px solid #ccc; }
        .editor-search input {
            width: 100%; padding: 6px; box-sizing: border-box;
            border: 1px solid #ccc; border-radius: 4px;
        }
        
        .config-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .config-list label, .config-section {
            display: block;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .config-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
    </style>
</head>
<body>

    <h1>Routified - Menedżer Tras i Punktów</h1>

    <h2>Wszystkie trasy (Routes):</h2>
    <button id="add-new-route-btn" class="main-action-btn add-btn-style">+ Dodaj nową trasę</button>
    <button id="download-routes-btn" class="main-action-btn download-btn-style">Pobierz wszystkie (CSV)</button>
    <ul id="route-list" class="item-list">
    </ul>

    <hr style="margin: 30px 0;">

    <h2>Wszystkie punkty (Waypoints):</h2>
    <button id="add-new-waypoint-btn" class="main-action-btn add-btn-style">+ Dodaj nowy punkt</button>
    <button id="download-waypoints-btn" class="main-action-btn download-btn-style">Pobierz wszystkie (CSV)</button>
    
    <ul id="waypoint-list" class="item-list">
    </ul>


    <div id="waypoint-form-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-waypoint-form-modal">×</span>
            <h2 id="waypoint-form-title">Dodaj nowy punkt:</h2>
            <form id="waypoint-form" class="form-layout">
                <input type="hidden" id="waypoint-id" name="waypoint-id">
                <label for="name">Nazwa:</label>
                <input type="text" id="name" name="name">
                <label for="city">Miasto:</label>
                <input type="text" id="city" name="city" class="validation-input">
                <label for="postal_code">Kod pocztowy:</label>
                <input type="text" id="postal_code" name="postal_code">
                <label for="street">Ulica:</label>
                <input type="text" id="street" name="street" class="validation-input">
                <label for="house_number">Nr budynku:</label>
                <input type="text" id="house_number" name="house_number" class="validation-input">
                <label for="apartment_number">Nr lokalu:</label>
                <input type="text" id="apartment_number" name="apartment_number">
                <label for="latitude">Szerokość (Lat):</label>
                <input type="text" id="latitude" name="latitude" class="validation-input">
                <label for="longitude">Długość (Lon):</label>
                <input type="text" id="longitude" name="longitude" class="validation-input">
                
                <p id="waypoint-form-validation-error" class="validation-error">
                    Przed zapisaniem musisz podać dokładne dane adresowe (miasto, ulica, nr budynku) lub współrzędne geograficzne (szerokość i długość).
                </p>
                
                <div class="modal-footer">
                    <button type="submit" id="waypoint-form-save-btn" class="add-btn-style" disabled>Zapisz Punkt</button>
                    <button type="button" id="waypoint-delete-in-form-btn" class="delete-btn-style" style="display: none;">Usuń ten punkt</button>
                </div>
            </form>
        </div>
    </div>

    <div id="waypoint-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-waypoint-view-modal">×</span>
            <h2>Podgląd punktu</h2>
            <div id="waypoint-view-modal-content" class="data-preview"></div>
            <div class="modal-footer">
                <button id="waypoint-view-modal-edit-btn" class="edit-btn-style">Edytuj ten punkt</button>
            </div>
        </div>
    </div>
    
    <div id="waypoint-confirmation-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-waypoint-confirm-modal">×</span>
            <h2 id="waypoint-confirm-title">Potwierdź</h2>
            <div id="waypoint-confirm-body" class="data-preview"></div>
            <div id="waypoint-confirm-footer-edit" class="modal-footer" style="display: none;">
                <button id="waypoint-confirm-save-btn" class="add-btn-style">Zapisz</button>
                <button id="waypoint-confirm-back-btn" type="button" class="cancel-btn-style">Wróć do edycji</button>
            </div>
            <div id="waypoint-confirm-footer-delete" class="modal-footer" style="display: none;">
                <button id="waypoint-confirm-delete-btn" class="delete-btn-style">Tak, usuń</button>
                <button id="waypoint-confirm-cancel-delete-btn" type="button" class="cancel-btn-style">Anuluj</button>
            </div>
        </div>
    </div>


    <div id="route-form-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-route-form-modal">×</span>
            <h2 id="route-form-title">Dodaj nową trasę:</h2>
            <form id="route-form" class="form-layout">
                <input type="hidden" id="route-id" name="route-id">
                <label for="route-name">Nazwa:</label>
                <input type="text" id="route-name" name="name" class="route-validation-input">
                <label for="route-description">Opis:</label>
                <textarea id="route-description" name="description" rows="4"></textarea>
                <p id="route-form-validation-error" class="validation-error">
                    Nazwa trasy jest wymagana.
                </p>
                <div class="modal-footer">
                    <button type="submit" id="route-form-save-btn" class="add-btn-style" disabled>Zapisz Trasę</button>
                    <button type="button" id="route-delete-in-form-btn" class="delete-btn-style" style="display: none;">Usuń tę trasę</button>
                </div>
            </form>
        </div>
    </div>

    <div id="route-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-route-view-modal">×</span>
            <h2>Podgląd trasy</h2>
            <div id="route-view-modal-content" class="data-preview"></div>
            <div class="modal-footer">
                <button id="route-view-modal-manage-btn" class="manage-btn-style pull-left">Zarządzaj punktami</button>
                <button id="route-view-modal-export-btn" class="download-btn-style">Eksportuj...</button>
                <button id="route-view-modal-edit-btn" class="edit-btn-style">Edytuj tę trasę</button>
            </div>
        </div>
    </div>
    
    <div id="route-confirmation-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-route-confirm-modal">×</span>
            <h2 id="route-confirm-title">Potwierdź</h2>
            <div id="route-confirm-body" class="data-preview"></div>
            <div id="route-confirm-footer-edit" class="modal-footer" style="display: none;">
                <button id="route-confirm-save-btn" class="add-btn-style">Zapisz</button>
                <button id="route-confirm-back-btn" type="button" class="cancel-btn-style">Wróć do edycji</button>
            </div>
            <div id="route-confirm-footer-delete" class="modal-footer" style="display: none;">
                <button id="route-confirm-delete-btn" class="delete-btn-style">Tak, usuń</button>
                <button id="route-confirm-cancel-delete-btn" type="button" class="cancel-btn-style">Anuluj</button>
            </div>
        </div>
    </div>

    <div id="route-editor-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-route-editor-modal">×</span>
            <h2 id="route-editor-title">Edytor Trasy</h2>
            <div class="route-editor-container">
                <div class="editor-column">
                    <h4>Punkty na trasie (przeciągnij, by zmienić kolejność)</h4>
                    <ul id="route-editor-current-list" class="editor-list">
                    </ul>
                </div>
                <div class="editor-column">
                    <h4>Biblioteka punktów (Dostępne)</h4>
                    <div class="editor-search">
                        <input type="text" id="route-editor-search" placeholder="Szukaj po nazwie, adresie, geo...">
                    </div>
                    <ul id="route-editor-available-list" class="editor-list">
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="route-editor-save-btn" type="button" class="add-btn-style" disabled>Zapisz zmiany</button>
                <button id="route-editor-done-btn" type="button" class="cancel-btn-style">Gotowe</button>
            </div>
        </div>
    </div>

    <div id="export-config-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-export-config-modal">×</span>
            <h2>Konfiguruj Eksport Trasy</h2>
            
            <div class="config-section">
                <h4>1. Wybierz format:</h4>
                <label><input type="radio" name="export-format" value="csv" checked> CSV (dla Excela)</label>
                <label><input type="radio" name="export-format" value="pdf"> PDF</label>
            </div>

            <div id="pdf-options" style="display: none; margin-top: 15px;" class="config-section">
                <h4>2. Opcje PDF:</h4>
                <label><input type="radio" name="orientation" value="portrait" checked> Pionowo (A4)</label>
                <label><input type="radio" name="orientation" value="landscape"> Poziomo (A4)</label>
                <br>
                <label><input type="checkbox" id="pdf-add-links" checked> Dodaj hiperłącza do map w nazwach</label>
            </div>
            
            <div style="margin-top: 15px;" class="config-section">
                <h4>3. Wybierz kolumny:</h4>
                <form id="export-config-form" class="config-list">
                    <label><input type="checkbox" name="sequence" checked> Kolejność</label>
                    <label><input type="checkbox" name="waypoint_id" checked> ID Punktu</label>
                    <label><input type="checkbox" name="waypoint_name" checked> Nazwa Punktu</label>
                    <label><input type="checkbox" name="city" checked> Miasto</label>
                    <label><input type="checkbox" name="street" checked> Ulica</label>
                    <label><input type="checkbox" name="house_number" checked> Nr budynku</label>
                    <label><input type="checkbox" name="postal_code"> Kod pocztowy</label>
                    <label><input type="checkbox" name="apartment_number"> Nr lokalu</label>
                    <label><input type="checkbox" name="latitude" checked> Szerokość (Lat)</label>
                    <label><input type="checkbox" name="longitude" checked> Długość (Lon)</label>
                </form>
            </div>
            
            <div class="modal-footer">
                <button id="config-download-btn" class="download-btn-style">Pobierz</button>
                <button id="config-cancel-btn" type="button" class="cancel-btn-style">Anuluj</button>
            </div>
        </div>
    </div>
    
    <div id="editor-unsaved-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-btn" id="close-editor-unsaved-modal">×</span>
            <h2 id="editor-unsaved-title">Niezapisane zmiany</h2>
            <div id="editor-unsaved-body" class="data-preview">
                <p>Masz niezapisane zmiany w edytorze trasy.</p>
                <p>Czy na pewno chcesz opuścić bez zapisywania?</p>
            </div>
            <div id="editor-unsaved-footer" class="modal-footer">
                <button id="editor-unsaved-leave-btn" class="delete-btn-style">Opuść</button>
                <button id="editor-unsaved-back-btn" type="button" class="cancel-btn-style">Wróć do edycji</button>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            
            let allWaypointsCache = []; 
            let currentRouteViewData = null; 
            
            const { jsPDF } = window.jspdf;
            
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const CSRF_TOKEN = getCookie('csrftoken');

            function openModal(modal) { 
                modal.classList.remove('fade-out');
                modal.style.display = 'block'; 
            }
            function closeModal(modal) { 
                modal.classList.add('fade-out');
                setTimeout(() => {
                    modal.style.display = 'none'; 
                    modal.classList.remove('fade-out');
                }, 300);
            }
            
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    
                    if (e.target.id === 'route-editor-modal') {
                        handleEditorClose();
                    } else if (e.target.id !== 'editor-unsaved-modal') {
                        closeModal(e.target);
                    }
                }
            });

            function convertToCSV(data) {
                if (data.length === 0) return "";
                const headers = Object.keys(data[0]);
                const csv = [
                    headers.join(','), 
                    ...data.map(row => headers.map(header => {
                        let cell = row[header];
                        if (cell === null || cell === undefined) return '';
                        cell = String(cell);
                        if (cell.includes(',') || cell.includes('\n') || cell.includes('"')) {
                            return `"${cell.replace(/"/g, '""')}"`;
                        }
                        return cell;
                    }).join(','))
                ].join('\n');
                return csv;
            }

            function downloadCSV(data, filename) {
                if (data.length === 0) { alert('Brak danych do pobrania.'); return; }
                const csvData = '\uFEFF' + convertToCSV(data);
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            
            const waypointList = document.getElementById('waypoint-list');
            const waypointForm = document.getElementById('waypoint-form');
            const waypointFormTitle = document.getElementById('waypoint-form-title');
            const waypointFormModal = document.getElementById('waypoint-form-modal');
            const waypointViewModal = document.getElementById('waypoint-view-modal');
            const waypointConfirmationModal = document.getElementById('waypoint-confirmation-modal');
            const addNewWaypointBtn = document.getElementById('add-new-waypoint-btn');
            const deleteInWaypointFormBtn = document.getElementById('waypoint-delete-in-form-btn');
            const waypointViewModalEditBtn = document.getElementById('waypoint-view-modal-edit-btn');
            const downloadWaypointsBtn = document.getElementById('download-waypoints-btn');
            const waypointViewModalContent = document.getElementById('waypoint-view-modal-content');
            const waypointConfirmTitle = document.getElementById('waypoint-confirm-title');
            const waypointConfirmBody = document.getElementById('waypoint-confirm-body');
            const waypointConfirmFooterEdit = document.getElementById('waypoint-confirm-footer-edit');
            const waypointConfirmFooterDelete = document.getElementById('waypoint-confirm-footer-delete');
            const waypointConfirmSaveBtn = document.getElementById('waypoint-confirm-save-btn');
            const waypointConfirmBackBtn = document.getElementById('waypoint-confirm-back-btn');
            const waypointConfirmDeleteBtn = document.getElementById('waypoint-confirm-delete-btn');
            const waypointConfirmCancelDeleteBtn = document.getElementById('waypoint-confirm-cancel-delete-btn');
            const waypointFormSaveBtn = document.getElementById('waypoint-form-save-btn');
            const waypointFormValidationError = document.getElementById('waypoint-form-validation-error');
            const wpCityInput = document.getElementById('city');
            const wpStreetInput = document.getElementById('street');
            const wpHouseInput = document.getElementById('house_number');
            const wpLatInput = document.getElementById('latitude');
            const wpLonInput = document.getElementById('longitude');
            const wpInputsToValidate = [wpCityInput, wpStreetInput, wpHouseInput, wpLatInput, wpLonInput];
            let pendingWaypointSaveData = null;
            let pendingWaypointSaveId = null;

            document.getElementById('close-waypoint-form-modal').addEventListener('click', () => closeModal(waypointFormModal));
            document.getElementById('close-waypoint-view-modal').addEventListener('click', () => closeModal(waypointViewModal));
            document.getElementById('close-waypoint-confirm-modal').addEventListener('click', () => closeModal(waypointConfirmationModal));
            
            addNewWaypointBtn.addEventListener('click', () => {
                resetWaypointForm();
                waypointFormTitle.textContent = 'Dodaj nowy punkt:';
                deleteInWaypointFormBtn.style.display = 'none';
                waypointFormSaveBtn.textContent = 'Zapisz Punkt';
                waypointFormSaveBtn.classList.remove('edit-btn-style');
                waypointFormSaveBtn.classList.add('add-btn-style');
                openModal(waypointFormModal);
            });

            async function getWaypoints() {
                const response = await fetch('/api/waypoints/');
                const waypoints = await response.json();
                allWaypointsCache = waypoints; 
                
                waypointList.innerHTML = ''; 
                waypoints.forEach(wp => {
                    const li = document.createElement('li');
                    const text = document.createElement('span');
                    let displayText = `${wp.name || 'Brak nazwy'}`;
                    if (wp.city && wp.street) displayText += ` (${wp.street} ${wp.house_number}, ${wp.city})`;
                    else if (wp.latitude) displayText += ` (${wp.latitude}, ${wp.longitude})`;
                    text.textContent = displayText;
                    li.appendChild(text);

                    const btnContainer = document.createElement('div');
                    const mapBtn = document.createElement('button');
                    mapBtn.textContent = 'Mapa';
                    mapBtn.classList.add('map-btn', 'map-btn-style');
                    mapBtn.dataset.id = wp.id; 
                    btnContainer.appendChild(mapBtn);
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'Podgląd';
                    viewBtn.classList.add('view-btn', 'view-btn-style');
                    viewBtn.dataset.id = wp.id; 
                    btnContainer.appendChild(viewBtn);

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.classList.add('edit-btn', 'edit-btn-style');
                    editBtn.dataset.id = wp.id; 
                    btnContainer.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Usuń';
                    deleteBtn.classList.add('delete-btn-style', 'delete-btn');
                    deleteBtn.dataset.id = wp.id; 
                    btnContainer.appendChild(deleteBtn);
                    
                    li.appendChild(btnContainer);
                    waypointList.appendChild(li);
                });
            }

            function resetWaypointForm() {
                waypointForm.reset();
                waypointForm.querySelector('#waypoint-id').value = '';
                waypointFormTitle.textContent = 'Dodaj nowy punkt:';
                deleteInWaypointFormBtn.style.display = 'none';
                pendingWaypointSaveData = null;
                pendingWaypointSaveId = null;
                liveValidateWaypointForm(); 
            }
            
            function liveValidateWaypointForm() {
                const hasAddress = wpCityInput.value.trim() && wpStreetInput.value.trim() && wpHouseInput.value.trim();
                const hasCoords = wpLatInput.value.trim() && wpLonInput.value.trim();
                const isValid = hasAddress || hasCoords;
                if (isValid) {
                    waypointFormSaveBtn.disabled = false;
                    waypointFormValidationError.style.display = 'none';
                } else {
                    waypointFormSaveBtn.disabled = true;
                    waypointFormValidationError.style.display = 'block';
                }
                return isValid;
            }
            
            wpInputsToValidate.forEach(input => input.addEventListener('input', liveValidateWaypointForm));

            function showWaypointEditConfirmation(data, id) {
                pendingWaypointSaveData = data; 
                pendingWaypointSaveId = id;
                
                if (id) {
                    waypointConfirmTitle.textContent = 'Potwierdź zmiany';
                    waypointConfirmSaveBtn.textContent = 'Zapisz zmiany';
                    waypointConfirmSaveBtn.classList.remove('add-btn-style');
                    waypointConfirmSaveBtn.classList.add('edit-btn-style');
                } else {
                    waypointConfirmTitle.textContent = 'Potwierdź dodanie';
                    waypointConfirmSaveBtn.textContent = 'Zapisz';
                    waypointConfirmSaveBtn.classList.remove('edit-btn-style');
                    waypointConfirmSaveBtn.classList.add('add-btn-style');
                }
                
                waypointConfirmBody.innerHTML = `
                    <p><strong>Nazwa:</strong> ${data.name || '---'}</p><hr>
                    <p><strong>Miasto:</strong> ${data.city || '---'}</p>
                    <p><strong>Kod pocztowy:</strong> ${data.postal_code || '---'}</p>
                    <p><strong>Ulica:</strong> ${data.street || '---'}</p>
                    <p><strong>Nr budynku:</strong> ${data.house_number || '---'}</p>
                    <p><strong>Nr lokalu:</strong> ${data.apartment_number || '---'}</p><hr>
                    <p><strong>Szerokość (Lat):</strong> ${data.latitude || '---'}</p>
                    <p><strong>Długość (Lon):</strong> ${data.longitude || '---'}</p>
                `;
                
                waypointConfirmFooterDelete.style.display = 'none';
                waypointConfirmFooterEdit.style.display = 'block';
                openModal(waypointConfirmationModal);
            }

            async function performWaypointSave() {
                if (!pendingWaypointSaveData) return;
                const data = pendingWaypointSaveData;
                const id = pendingWaypointSaveId;
                
                let url = '/api/waypoints/';
                let method = 'POST';
                if (id) {
                    url = `/api/waypoints/${id}/`;
                    method = 'PATCH'; 
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    resetWaypointForm();
                    closeModal(waypointFormModal);
                    closeModal(waypointConfirmationModal);
                    getWaypoints();
                } else {
                    alert('Błąd zapisu po stronie serwera! Prawdopodobnie duplikat.');
                    closeModal(waypointConfirmationModal);
                }
            }
            
            async function showWaypointDeleteConfirmation(id) {
                const response = await fetch(`/api/waypoints/${id}/`);
                if (!response.ok) { alert('Nie można pobrać danych punktu.'); return; }
                const wp = await response.json();
                
                waypointConfirmTitle.textContent = 'Potwierdź usunięcie';
                waypointConfirmBody.innerHTML = `
                    <p>Czy na pewno chcesz usunąć punkt:</p>
                    <p><strong>#${wp.id} - ${wp.name || (wp.street + ' ' + wp.house_number) || 'Punkt bez nazwy'}</strong></p>
                    <p style="color: red; font-weight: bold;">Usunięcie tego punktu jest nieodwracalne!</p>
                `;
                
                waypointConfirmFooterEdit.style.display = 'none';
                waypointConfirmFooterDelete.style.display = 'block';
                waypointConfirmDeleteBtn.dataset.id = id;
                
                closeModal(waypointFormModal); 
                openModal(waypointConfirmationModal);
            }

            async function performWaypointDelete(id) {
                const response = await fetch(`/api/waypoints/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': CSRF_TOKEN }
                });
                if (response.ok) {
                    closeModal(waypointConfirmationModal);
                    getWaypoints();
                } else {
                    alert('Nie można usunąć tego punktu (może być używany przez trasę?).');
                }
            }

            async function handleWaypointEdit(id) {
                const response = await fetch(`/api/waypoints/${id}/`);
                const wp = await response.json();
                waypointForm.querySelector('#waypoint-id').value = wp.id;
                waypointForm.querySelector('#name').value = wp.name;
                waypointForm.querySelector('#city').value = wp.city;
                waypointForm.querySelector('#postal_code').value = wp.postal_code;
                waypointForm.querySelector('#street').value = wp.street;
                waypointForm.querySelector('#house_number').value = wp.house_number;
                waypointForm.querySelector('#apartment_number').value = wp.apartment_number;
                waypointForm.querySelector('#latitude').value = wp.latitude;
                waypointForm.querySelector('#longitude').value = wp.longitude;
                waypointFormTitle.textContent = `Edytujesz punkt #${wp.id}`;
                deleteInWaypointFormBtn.style.display = 'inline-block';
                deleteInWaypointFormBtn.dataset.id = wp.id;
                waypointFormSaveBtn.textContent = 'Zapisz zmiany w punkcie';
                waypointFormSaveBtn.classList.remove('add-btn-style');
                waypointFormSaveBtn.classList.add('edit-btn-style');
                liveValidateWaypointForm(); 
                openModal(waypointFormModal);
            }
            
            async function handleWaypointView(id) {
                const response = await fetch(`/api/waypoints/${id}/`);
                const wp = await response.json();
                waypointViewModalContent.innerHTML = `
                    <p><strong>ID:</strong> ${wp.id}</p>
                    <p><strong>Nazwa:</strong> ${wp.name || '---'}</p><hr>
                    <p><strong>Miasto:</strong> ${wp.city || '---'}</p>
                    <p><strong>Kod pocztowy:</strong> ${wp.postal_code || '---'}</p>
                    <p><strong>Ulica:</strong> ${wp.street || '---'}</p>
                    <p><strong>Nr budynku:</strong> ${wp.house_number || '---'}</p>
                    <p><strong>Nr lokalu:</strong> ${wp.apartment_number || '---'}</p><hr>
                    <p><strong>Szerokość (Lat):</strong> ${wp.latitude || '---'}</p>
                    <p><strong>Długość (Lon):</strong> ${wp.longitude || '---'}</p>
                `;
                waypointViewModalEditBtn.dataset.id = wp.id;
                openModal(waypointViewModal);
            }
            
            // POPRAWKA: Prawidłowy URL do Google Maps
            function getGoogleMapsUrl(wp) {
                if (!wp) return null;
                let query = "";
                if (wp.latitude && wp.longitude) {
                    query = `${wp.latitude},${wp.longitude}`;
                } 
                else if (wp.city && wp.street && wp.house_number) {
                    const address = `${wp.street} ${wp.house_number}, ${wp.postal_code || ''} ${wp.city}`;
                    query = encodeURIComponent(address);
                } 
                else {
                    return null;
                }
                return `https://www.google.com/maps/search/?api=1&query=${query}`;
            }
            
            function handleWaypointMap(id) {
                const wp = allWaypointsCache.find(w => w.id == id);
                if (!wp) { alert("Nie znaleziono danych punktu!"); return; }
                const url = getGoogleMapsUrl(wp);
                
                if (url) {
                    window.open(url, '_blank');
                } else {
                    alert("Nie można otworzyć mapy. Brak wystarczających danych (współrzędnych lub adresu).");
                }
            }
            
            async function downloadWaypoints() {
                await getWaypoints(); 
                downloadCSV(allWaypointsCache, 'waypoints.csv');
            }

            waypointForm.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                if (!liveValidateWaypointForm()) return; 
                const formData = new FormData(waypointForm);
                const currentEditId = formData.get('waypoint-id');
                const data = {
                    name: formData.get('name') || "", city: formData.get('city') || "",
                    postal_code: formData.get('postal_code') || "", street: formData.get('street') || "",
                    house_number: formData.get('house_number') || "", apartment_number: formData.get('apartment_number') || "",
                    latitude: formData.get('latitude') || null, longitude: formData.get('longitude') || null
                };
                showWaypointEditConfirmation(data, currentEditId || null);
            });
            waypointList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return; const id = target.dataset.id; if (!id) return;
                
                if (target.classList.contains('map-btn')) handleWaypointMap(id);
                if (target.classList.contains('view-btn')) handleWaypointView(id);
                if (target.classList.contains('edit-btn')) handleWaypointEdit(id);
                if (target.classList.contains('delete-btn')) showWaypointDeleteConfirmation(id);
            });
            deleteInWaypointFormBtn.addEventListener('click', (e) => { const id = e.target.dataset.id; if (id) showWaypointDeleteConfirmation(id); });
            waypointViewModalEditBtn.addEventListener('click', (e) => { const id = e.target.dataset.id; closeModal(waypointViewModal); handleWaypointEdit(id); });
            downloadWaypointsBtn.addEventListener('click', downloadWaypoints);
            waypointConfirmSaveBtn.addEventListener('click', () => performWaypointSave());
            waypointConfirmBackBtn.addEventListener('click', () => closeModal(waypointConfirmationModal));
            waypointConfirmDeleteBtn.addEventListener('click', (e) => performWaypointDelete(e.target.dataset.id));
            waypointConfirmCancelDeleteBtn.addEventListener('click', () => {
                closeModal(waypointConfirmationModal);
                if (waypointForm.querySelector('#waypoint-id').value) openModal(waypointFormModal);
            });

            
            
            
            const routeList = document.getElementById('route-list');
            const routeForm = document.getElementById('route-form');
            const routeFormTitle = document.getElementById('route-form-title');
            const routeFormModal = document.getElementById('route-form-modal');
            const routeViewModal = document.getElementById('route-view-modal');
            const routeConfirmationModal = document.getElementById('route-confirmation-modal');
            const addNewRouteBtn = document.getElementById('add-new-route-btn');
            const deleteInRouteFormBtn = document.getElementById('route-delete-in-form-btn');
            const routeViewModalEditBtn = document.getElementById('route-view-modal-edit-btn');
            const downloadRoutesBtn = document.getElementById('download-routes-btn');
            const routeViewModalContent = document.getElementById('route-view-modal-content');
            const routeConfirmTitle = document.getElementById('route-confirm-title');
            const routeConfirmBody = document.getElementById('route-confirm-body');
            const routeConfirmFooterEdit = document.getElementById('route-confirm-footer-edit');
            const routeConfirmFooterDelete = document.getElementById('route-confirm-footer-delete');
            const routeConfirmSaveBtn = document.getElementById('route-confirm-save-btn');
            const routeConfirmBackBtn = document.getElementById('route-confirm-back-btn');
            const routeConfirmDeleteBtn = document.getElementById('route-confirm-delete-btn');
            const routeConfirmCancelDeleteBtn = document.getElementById('route-confirm-cancel-delete-btn');
            const routeFormSaveBtn = document.getElementById('route-form-save-btn');
            const routeFormValidationError = document.getElementById('route-form-validation-error');
            const routeNameInput = document.getElementById('route-name');
            const routeEditorModal = document.getElementById('route-editor-modal');
            const routeEditorTitle = document.getElementById('route-editor-title');
            const routeEditorCurrentList = document.getElementById('route-editor-current-list');
            const routeEditorAvailableList = document.getElementById('route-editor-available-list');
            const routeEditorSearchInput = document.getElementById('route-editor-search');
            const routeViewModalManageBtn = document.getElementById('route-view-modal-manage-btn');
            const routeViewModalExportBtn = document.getElementById('route-view-modal-export-btn'); 
            const routeEditorSaveBtn = document.getElementById('route-editor-save-btn');
            const routeEditorDoneBtn = document.getElementById('route-editor-done-btn');
            
            const exportConfigModal = document.getElementById('export-config-modal'); 
            const configDownloadBtn = document.getElementById('config-download-btn');
            const configCancelBtn = document.getElementById('config-cancel-btn');
            const configForm = document.getElementById('export-config-form'); 
            const pdfOptions = document.getElementById('pdf-options');
            
            const editorUnsavedModal = document.getElementById('editor-unsaved-modal');
            const closeEditorUnsavedModal = document.getElementById('close-editor-unsaved-modal');
            const editorUnsavedLeaveBtn = document.getElementById('editor-unsaved-leave-btn');
            const editorUnsavedBackBtn = document.getElementById('editor-unsaved-back-btn');

            let currentEditingRouteId = null;
            let pendingRouteSaveData = null;
            let pendingRouteSaveId = null;
            let currentRouteViewDataForDownload = null;
            
            let editorWaypointMap = new Map();
            let originalRouteWaypoints = []; 
            let editorRouteWaypoints = []; 
            let isEditorDirty = false;
            let sortableInstance = null; // POPRAWKA: Przechowuje instancję Sortable.js
            
            document.getElementById('close-route-form-modal').addEventListener('click', () => closeModal(routeFormModal));
            document.getElementById('close-route-view-modal').addEventListener('click', () => closeModal(routeViewModal));
            document.getElementById('close-route-confirm-modal').addEventListener('click', () => closeModal(routeConfirmationModal));
            document.getElementById('close-route-editor-modal').addEventListener('click', () => handleEditorClose());
            document.getElementById('route-editor-done-btn').addEventListener('click', () => handleEditorClose());
            document.getElementById('close-export-config-modal').addEventListener('click', () => closeModal(exportConfigModal)); 
            
            closeEditorUnsavedModal.addEventListener('click', () => closeModal(editorUnsavedModal));
            editorUnsavedBackBtn.addEventListener('click', () => closeModal(editorUnsavedModal));
            editorUnsavedLeaveBtn.addEventListener('click', () => {
                closeModal(editorUnsavedModal);
                closeModal(routeEditorModal);
                isEditorDirty = false; 
            });


            addNewRouteBtn.addEventListener('click', () => {
                resetRouteForm();
                routeFormTitle.textContent = 'Dodaj nową trasę:';
                deleteInRouteFormBtn.style.display = 'none';
                routeFormSaveBtn.textContent = 'Zapisz Trasę';
                routeFormSaveBtn.classList.remove('edit-btn-style');
                routeFormSaveBtn.classList.add('add-btn-style');
                openModal(routeFormModal);
            });

            async function getRoutes() {
                const response = await fetch('/api/routes/');
                const routes = await response.json();
                routeList.innerHTML = ''; 
                routes.forEach(route => {
                    const li = document.createElement('li');
                    const text = document.createElement('span');
                    text.textContent = route.name;
                    li.appendChild(text);

                    const btnContainer = document.createElement('div');
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'Podgląd';
                    viewBtn.classList.add('view-btn', 'view-btn-style');
                    viewBtn.dataset.id = route.id; 
                    btnContainer.appendChild(viewBtn);

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edytuj';
                    editBtn.classList.add('edit-btn', 'edit-btn-style');
                    editBtn.dataset.id = route.id; 
                    btnContainer.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Usuń';
                    deleteBtn.classList.add('delete-btn-style', 'delete-btn');
                    deleteBtn.dataset.id = route.id; 
                    btnContainer.appendChild(deleteBtn);
                    
                    li.appendChild(btnContainer);
                    routeList.appendChild(li);
                });
            }

            function resetRouteForm() {
                routeForm.reset();
                routeForm.querySelector('#route-id').value = '';
                routeFormTitle.textContent = 'Dodaj nową trasę:';
                deleteInRouteFormBtn.style.display = 'none';
                pendingRouteSaveData = null;
                pendingRouteSaveId = null;
                liveValidateRouteForm(); 
            }
            
            function liveValidateRouteForm() {
                const isValid = routeNameInput.value.trim() !== "";
                if (isValid) {
                    routeFormSaveBtn.disabled = false;
                    routeFormValidationError.style.display = 'none';
                } else {
                    routeFormSaveBtn.disabled = true;
                    routeFormValidationError.style.display = 'block';
                }
                return isValid;
            }
            
            routeNameInput.addEventListener('input', liveValidateRouteForm);

            function showRouteEditConfirmation(data, id) {
                pendingRouteSaveData = data; 
                pendingRouteSaveId = id;
                
                if (id) {
                    routeConfirmTitle.textContent = 'Potwierdź zmiany';
                    routeConfirmSaveBtn.textContent = 'Zapisz zmiany';
                    routeConfirmSaveBtn.classList.remove('add-btn-style');
                    routeConfirmSaveBtn.classList.add('edit-btn-style');
                } else {
                    routeConfirmTitle.textContent = 'Potwierdź dodanie';
                    routeConfirmSaveBtn.textContent = 'Zapisz';
                    routeConfirmSaveBtn.classList.remove('edit-btn-style');
                    routeConfirmSaveBtn.classList.add('add-btn-style');
                }
                
                routeConfirmBody.innerHTML = `
                    <p><strong>Nazwa:</strong> ${data.name || '---'}</p>
                    <p><strong>Opis:</strong> ${data.description || '---'}</p>
                `;
                
                routeConfirmFooterDelete.style.display = 'none';
                routeConfirmFooterEdit.style.display = 'block';
                openModal(routeConfirmationModal);
            }

            async function performRouteSave() {
                if (!pendingRouteSaveData) return;
                const data = pendingRouteSaveData;
                const id = pendingRouteSaveId;
                
                let url = '/api/routes/';
                let method = 'POST';
                if (id) {
                    url = `/api/routes/${id}/`;
                    method = 'PATCH'; 
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    resetRouteForm();
                    closeModal(routeFormModal);
                    closeModal(routeConfirmationModal);
                    getRoutes();
                } else {
                    alert('Błąd zapisu trasy po stronie serwera!');
                    closeModal(routeConfirmationModal);
                }
            }
            
            async function showRouteDeleteConfirmation(id) {
                const response = await fetch(`/api/routes/${id}/`);
                if (!response.ok) { alert('Nie można pobrać danych trasy.'); return; }
                const route = await response.json();
                
                routeConfirmTitle.textContent = 'Potwierdź usunięcie';
                routeConfirmBody.innerHTML = `
                    <p>Czy na pewno chcesz usunąć trasę:</p>
                    <p><strong>#${route.id} - ${route.name}</strong></p>
                    <p style="color: red; font-weight: bold;">Usunięcie tej trasy jest nieodwracalne!</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">(Punkty użyte w tej trasie <strong>nie</strong> zostaną usunięte z biblioteki punktów).</p>
                `;
                
                routeConfirmFooterEdit.style.display = 'none';
                routeConfirmFooterDelete.style.display = 'block';
                routeConfirmDeleteBtn.dataset.id = id;
                
                closeModal(routeFormModal); 
                openModal(routeConfirmationModal);
            }

            async function performRouteDelete(id) {
                const response = await fetch(`/api/routes/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': CSRF_TOKEN }
                });
                if (response.ok) {
                    closeModal(routeConfirmationModal);
                    getRoutes();
                } else {
                    alert('Nie można usunąć tej trasy.');
                }
            }

            async function handleRouteEdit(id) {
                const response = await fetch(`/api/routes/${id}/`);
                const route = await response.json();
                routeForm.querySelector('#route-id').value = route.id;
                routeForm.querySelector('#route-name').value = route.name;
                routeForm.querySelector('#route-description').value = route.description;
                routeFormTitle.textContent = `Edytujesz trasę #${route.id}`;
                deleteInRouteFormBtn.style.display = 'inline-block';
                deleteInRouteFormBtn.dataset.id = route.id;
                
                routeFormSaveBtn.textContent = 'Zapisz zmiany w trasie';
                routeFormSaveBtn.classList.remove('add-btn-style');
                routeFormSaveBtn.classList.add('edit-btn-style');
                
                liveValidateRouteForm(); 
                openModal(routeFormModal);
            }
            
            async function handleRouteView(id) {
                currentRouteViewData = null;
                
                const routeResponse = await fetch(`/api/routes/${id}/`);
                const route = await routeResponse.json();
                
                const routeWaypointsResponse = await fetch(`/api/route-waypoints/?route=${id}`);
                const routeWaypoints = await routeWaypointsResponse.json();
                routeWaypoints.sort((a, b) => a.sequence - b.sequence);
                
                let waypointsHtml = '<h4>Punkty na trasie (w kolejności):</h4><ol>';
                const waypointsForExport = [];
                
                if (routeWaypoints.length > 0) {
                    const waypointMap = new Map(allWaypointsCache.map(wp => [wp.id, wp]));
                    routeWaypoints.forEach(rw => {
                        const waypoint = waypointMap.get(rw.waypoint);
                        if(waypoint) { 
                            waypointsHtml += `<li>${getWaypointDisplay(waypoint)}</li>`;
                            waypointsForExport.push({
                                sequence: rw.sequence,
                                waypoint_id: waypoint.id,
                                waypoint_name: waypoint.name,
                                city: waypoint.city,
                                street: waypoint.street,
                                house_number: waypoint.house_number,
                                postal_code: waypoint.postal_code,
                                apartment_number: waypoint.apartment_number,
                                latitude: waypoint.latitude,
                                longitude: waypoint.longitude
                            });
                        }
                    });
                } else {
                    waypointsHtml += '<li>Brak punktów na tej trasie.</li>';
                }
                waypointsHtml += '</ol>';
                
                routeViewModalContent.innerHTML = `
                    <p><strong>ID:</strong> ${route.id}</p>
                    <p><strong>Nazwa:</strong> ${route.name || '---'}</p>
                    <p><strong>Opis:</strong> ${route.description || '---'}</p>
                    <hr>
                    ${waypointsHtml}
                `;
                
                routeViewModalEditBtn.dataset.id = route.id;
                routeViewModalManageBtn.dataset.id = route.id;
                routeViewModalManageBtn.dataset.name = route.name;
                
                currentRouteViewData = {
                    routeName: route.name,
                    waypoints: waypointsForExport
                };
                
                openModal(routeViewModal);
            }

            async function downloadRoutes() {
                const response = await fetch('/api/routes/');
                const routes = await response.json();
                downloadCSV(routes, 'routes.csv');
            }
            
            async function downloadPDF(fullData, filename, orientation, addLinks, selectedHeaders) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: orientation });

                // POPRAWKA: Ustawienie czcionki wspierającej polskie znaki
                doc.setFont('roboto', 'normal');

                const headerMap = {
                    'sequence': 'Lp.', 'waypoint_id': 'ID Punktu', 'waypoint_name': 'Nazwa',
                    'city': 'Miasto', 'street': 'Ulica', 'house_number': 'Nr budynku',
                    'postal_code': 'Kod Pocztowy', 'apartment_number': 'Nr lokalu',
                    'latitude': 'Szerokość', 'longitude': 'Długość'
                };

                const head = [selectedHeaders.map(h => headerMap[h] || h)];
                
                const body = fullData.map(wp_row => {
                    return selectedHeaders.map(header => {
                        const cellData = wp_row[header] || '';
                        
                        if (addLinks && header === 'waypoint_name') {
                            const url = getGoogleMapsUrl(wp_row);
                            if (url) {
                                return { content: cellData, styles: { href: url, textColor: [0, 0, 255], fontStyle: 'italic'} };
                            }
                        }
                        return cellData;
                    });
                });

                doc.text(`Trasa: ${currentRouteViewData.routeName}`, 14, 15);
                
                doc.autoTable({ 
                    head: head, 
                    body: body,
                    startY: 20,
                    // POPRAWKA: Użycie czcionki roboto
                    styles: { font: "roboto", fontStyle: 'normal' },
                    headStyles: { fontStyle: 'bold', font: 'roboto' }
                });
                doc.save(filename.replace('.csv', '.pdf'));
            }

            function performExport() {
                if (!currentRouteViewData) { alert("Błąd: Brak danych trasy."); return; }
                if (currentRouteViewData.waypoints.length === 0) { alert("Ta trasa nie ma żadnych punktów do pobrania."); return; }
                
                const format = document.querySelector('input[name="export-format"]:checked').value;
                
                const selectedHeaders = [];
                configForm.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedHeaders.push(checkbox.name);
                });
                
                if(selectedHeaders.length === 0) {
                    alert("Musisz wybrać przynajmniej jedną kolumnę do eksportu.");
                    return;
                }

                const dataToExport = currentRouteViewData.waypoints.map(row => {
                    const newRow = {};
                    selectedHeaders.forEach(header => {
                        newRow[header] = row[header];
                    });
                    return newRow;
                });
                
                const filename = `${currentRouteViewData.routeName.replace(/[^a-z0-9]/gi, '_')}_punkty`;
                
                if (format === 'csv') {
                    downloadCSV(dataToExport, filename + '.csv');
                } else if (format === 'pdf') {
                    const orientation = document.querySelector('input[name="orientation"]:checked').value;
                    const addLinks = document.getElementById('pdf-add-links').checked;
                    downloadPDF(currentRouteViewData.waypoints, filename + '.pdf', orientation, addLinks, selectedHeaders);
                }
                
                closeModal(exportConfigModal);
            }

            function getWaypointDisplay(wp) {
                if (!wp) return "Błąd: Brak danych punktu";
                let name = wp.name || 'Brak nazwy';
                if (wp.city && wp.street) name += ` (${wp.street} ${wp.house_number}, ${wp.city})`;
                else if (wp.latitude) name += ` (${wp.latitude}, ${wp.longitude})`;
                return name;
            }

            function handleEditorClose() {
                if (isEditorDirty) {
                    openModal(editorUnsavedModal);
                } else {
                    closeModal(routeEditorModal);
                }
            }

            async function populateEditorWaypointMap() {
                if (allWaypointsCache.length === 0) {
                    await getWaypoints();
                }
                editorWaypointMap = new Map(allWaypointsCache.map(wp => [wp.id, wp]));
            }

            function renderEditorLists(searchTerm = "") {
                routeEditorCurrentList.innerHTML = '';
                routeEditorAvailableList.innerHTML = '';
                
                const lowerSearchTerm = searchTerm.toLowerCase();
                
                editorRouteWaypoints.sort((a, b) => a.sequence - b.sequence);
                
                editorRouteWaypoints.forEach((rw, index) => {
                    rw.sequence = index + 1; 
                    const waypoint = editorWaypointMap.get(rw.waypoint);
                    const li = document.createElement('li');
                    li.dataset.routeWaypointId = rw.id; 
                    li.dataset.waypointId = rw.waypoint;
                    li.innerHTML = `
                        <span><strong>${rw.sequence}.</strong> ${getWaypointDisplay(waypoint)}</span>
                        <button class="route-editor-remove-btn delete-btn-style" data-route-waypoint-id="${rw.id}">Usuń</button>
                    `;
                    routeEditorCurrentList.appendChild(li);
                });
                
                const availableWaypoints = allWaypointsCache.filter(wp => {
                    if (searchTerm === "") return true;
                    
                    const searchableText = [
                        wp.name, wp.city, wp.street, wp.house_number,
                        wp.latitude, wp.longitude
                    ].join(' ').toLowerCase();
                    
                    return searchableText.includes(lowerSearchTerm);
                });
                
                availableWaypoints.forEach(wp => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${getWaypointDisplay(wp)}</span>
                        <button class="route-editor-add-btn add-btn-style" data-waypoint-id="${wp.id}">+ Dodaj</button>
                    `;
                    routeEditorAvailableList.appendChild(li);
                });

                routeEditorSaveBtn.disabled = !isEditorDirty;
            }
            
            routeEditorSearchInput.addEventListener('input', (e) => {
                if (currentEditingRouteId) {
                    renderEditorLists(e.target.value);
                }
            });

            routeEditorAvailableList.addEventListener('click', async (e) => {
                const target = e.target.closest('button.route-editor-add-btn');
                if (!target) return;
                
                const waypointId = parseInt(target.dataset.waypointId, 10);
                if (!waypointId || !currentEditingRouteId) return;
                
                const maxSequence = editorRouteWaypoints.length > 0 ? Math.max(...editorRouteWaypoints.map(rw => rw.sequence)) : 0;
                
                const newRouteWaypoint = {
                    id: `temp-${Date.now()}`, 
                    route: currentEditingRouteId,
                    waypoint: waypointId,
                    sequence: maxSequence + 1
                };

                editorRouteWaypoints.push(newRouteWaypoint);
                isEditorDirty = true;
                renderEditorLists(routeEditorSearchInput.value);
            });
            
            routeEditorCurrentList.addEventListener('click', async (e) => {
                const target = e.target.closest('button.route-editor-remove-btn');
                if (!target) return;
                
                const routeWaypointId = target.dataset.routeWaypointId; 
                if (!routeWaypointId || !currentEditingRouteId) return;

                editorRouteWaypoints = editorRouteWaypoints.filter(rw => rw.id != routeWaypointId);
                isEditorDirty = true;
                renderEditorLists(routeEditorSearchInput.value);
            });

            async function performRouteEditorSave() {
                if (!isEditorDirty) return;
                
                routeEditorSaveBtn.disabled = true;
                routeEditorSaveBtn.textContent = 'Zapisywanie...';

                const originalIds = new Set(originalRouteWaypoints.map(rw => rw.id));
                const currentRws = [...editorRouteWaypoints]; 
                
                const deletePromises = [];
                for (const rw of originalRouteWaypoints) {
                    if (!currentRws.find(crw => crw.id === rw.id)) {
                        deletePromises.push(
                            fetch(`/api/route-waypoints/${rw.id}/`, {
                                method: 'DELETE',
                                headers: { 'X-CSRFToken': CSRF_TOKEN }
                            })
                        );
                    }
                }
                
                try {
                    await Promise.all(deletePromises);
                } catch (err) {
                    console.error("Błąd podczas usuwania punktów:", err);
                    alert("Wystąpił błąd podczas usuwania punktów. Spróbuj ponownie.");
                    routeEditorSaveBtn.disabled = false;
                    routeEditorSaveBtn.textContent = 'Zapisz zmiany';
                    return;
                }

                const offset = 1000;
                const tempPromises = [];
                const newRwMapping = []; 

                currentRws.forEach((rw, index) => {
                    const tempSequence = offset + index + 1;
                    let promise;
                    if (String(rw.id).startsWith('temp-')) {
                        promise = fetch('/api/route-waypoints/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                            body: JSON.stringify({ route: rw.route, waypoint: rw.waypoint, sequence: tempSequence })
                        });
                    } else {
                        promise = fetch(`/api/route-waypoints/${rw.id}/`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                            body: JSON.stringify({ sequence: tempSequence })
                        });
                    }
                    tempPromises.push(promise);
                    newRwMapping.push({ old: rw, promise });
                });

                const tempResults = await Promise.all(tempPromises);
                
                const finalPromises = [];
                for (let i = 0; i < tempResults.length; i++) {
                    const res = tempResults[i];
                    if (!res.ok) {
                        console.error("Błąd w etapie 1 (tymczasowym) zapisu.", await res.text());
                        continue;
                    }
                    const newRw = await res.json();
                    const finalSequence = i + 1;
                    
                    finalPromises.push(
                        fetch(`/api/route-waypoints/${newRw.id}/`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                            body: JSON.stringify({ sequence: finalSequence })
                        })
                    );
                }

                await Promise.all(finalPromises);
                
                isEditorDirty = false;
                routeEditorSaveBtn.textContent = 'Zapisz zmiany';
                closeModal(routeEditorModal);
                
            }

            routeEditorSaveBtn.addEventListener('click', performRouteEditorSave);
            
            // POPRAWKA: Inicjalizacja Sortable.js przeniesiona do otwierania modala,
            // a 'onEnd' uproszczone, aby nie renderować całej listy na nowo.
            
            routeForm.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                if (!liveValidateRouteForm()) return; 
                const formData = new FormData(routeForm);
                const currentEditId = formData.get('route-id');
                const data = { name: formData.get('name') || "", description: formData.get('description') || "" };
                showRouteEditConfirmation(data, currentEditId || null);
            });

            routeList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const id = target.dataset.id;
                if (!id) return;
                
                if (target.classList.contains('view-btn')) handleRouteView(id);
                if (target.classList.contains('edit-btn')) handleRouteEdit(id);
                if (target.classList.contains('delete-btn')) showRouteDeleteConfirmation(id);
            });

            deleteInRouteFormBtn.addEventListener('click', (e) => { const id = e.target.dataset.id; if (id) showRouteDeleteConfirmation(id); });
            routeViewModalEditBtn.addEventListener('click', (e) => { const id = e.target.dataset.id; closeModal(routeViewModal); handleRouteEdit(id); });
            downloadRoutesBtn.addEventListener('click', downloadRoutes);
            
            routeViewModalManageBtn.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                const name = e.target.dataset.name;
                currentEditingRouteId = id;
                routeEditorTitle.textContent = `Edytor Trasy: ${name}`;
                closeModal(routeViewModal); 
                routeEditorSearchInput.value = '';
                
                await populateEditorWaypointMap();
                
                const routeWaypointsResponse = await fetch(`/api/route-waypoints/?route=${id}`);
                const waypoints = await routeWaypointsResponse.json();
                waypoints.sort((a, b) => a.sequence - b.sequence);
                
                originalRouteWaypoints = JSON.parse(JSON.stringify(waypoints)); 
                editorRouteWaypoints = waypoints; 
                isEditorDirty = false; 

                renderEditorLists();
                
                // POPRAWKA: Inicjalizuj Sortable.js tutaj, po wyrenderowaniu listy
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                sortableInstance = new Sortable(routeEditorCurrentList, {
                    animation: 150,
                    onEnd: (evt) => {
                        // 1. Przesuń element w tablicy danych
                        const [movedItem] = editorRouteWaypoints.splice(evt.oldIndex, 1);
                        editorRouteWaypoints.splice(evt.newIndex, 0, movedItem);

                        // 2. Oznacz jako "brudny"
                        isEditorDirty = true;
                        routeEditorSaveBtn.disabled = false;

                        // 3. Zaktualizuj tylko numery porządkowe w DOM
                        const items = routeEditorCurrentList.querySelectorAll('li');
                        items.forEach((item, index) => {
                            editorRouteWaypoints[index].sequence = index + 1; // Zsynchronizuj dane
                            const strongTag = item.querySelector('span > strong');
                            if (strongTag) {
                                strongTag.textContent = `${index + 1}.`;
                            }
                        });
                    }
                });

                openModal(routeEditorModal);
            });
            
            routeViewModalExportBtn.addEventListener('click', () => { 
                if (currentRouteViewData && currentRouteViewData.waypoints.length > 0) {
                    openModal(exportConfigModal);
                } else {
                    alert("Trasa jest pusta. Dodaj punkty, aby ją wyeksportować.");
                }
            });
            
            configCancelBtn.addEventListener('click', () => {
                closeModal(exportConfigModal);
            });
            
            configDownloadBtn.addEventListener('click', () => {
                performExport();
            });
            
            document.querySelectorAll('input[name="export-format"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    pdfOptions.style.display = e.target.value === 'pdf' ? 'block' : 'none';
                });
            });
            
            routeConfirmSaveBtn.addEventListener('click', () => performRouteSave());
            routeConfirmBackBtn.addEventListener('click', () => closeModal(routeConfirmationModal));
            routeConfirmDeleteBtn.addEventListener('click', (e) => performRouteDelete(e.target.dataset.id));
            routeConfirmCancelDeleteBtn.addEventListener('click', () => {
                closeModal(routeConfirmationModal);
                if (routeForm.querySelector('#route-id').value) openModal(routeFormModal);
            });

            async function initializeApp() {
                await getWaypoints(); 
                getRoutes(); 
            }
            
            initializeApp();
        });
    </script>

</body>
</html>